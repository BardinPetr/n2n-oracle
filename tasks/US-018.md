## US-018 Контракт моста: экономичная посылка подтверждений в левую сторону

**Описание**: Я, как валидатор моста, хочу, чтобы мост потреблял меньше средств на комиссии транзакций. Если рассмотрим ситуацию, что в левой части моста сеть с большими комиссиями, то ПО моста должно минимизировать количество транзакций в левую часть, сохраняя тот же уровень безопасности и децентрализации.

В данной US подразумевается, что ABI контрактов мостов изменяется. Добавляются следуюшие методы:

* Контракт моста с правой стороны:
   * метод `enableRobustMode()` позволяет администратору включить режим экономичной пересылки. Обратной силы настройка не имеет.
   * метод `registerCommit(address recipient, uint256 amount, bytes32 id, uint256 r, uint256 s, uint8 v)`, позволяет валидатору моста отправить в виде цифровой подписи подтвреждение о наличии конкретного запроса на отправку нативных токенов через мост из правой стороны. В тот момент, когда достаточно подтверждений получено, испускает событие `commitsCollected(bytes32 id, uint8 commits)`, где `commits` -- количество собранных подтверждений. Метод работает только если был заранее вызван `enableRobustMode()`.
   * метод `getTransferDetails(bytes32 id)` возвращает `(address recipient, uint256 amount)` для конкретного запроса на отправку нативных токенов через мост из правой стороны. 
   * метод `getCommit(bytes32 id, uint8 index)` возвращает `(uint256 r, uint256 s, uint8 v)` -- подпись одного из валидаторов для конкретного запроса на отправку нативных токенов через мост из правой стороны.
   * метод `getRobustModeMessage(address recipient, uint256 amount, bytes32 id) returns(bytes) ` возвращает набор данных, который бы использовался, как вход для `encode_defunct()` функции из `eth_account.messages` для последующего формирования цифровой подписи, передаваемой в `registerCommit`.

* Контракт моста с левой стороны:
   * метод  `enableRobustMode()` позволяет администратору включить режим экономичной пересылки. Обратной силы настройка не имеет. После включения данного режима метод `commit` в контракте моста с левой стороны всегда возвращает `revert`.
   * метод `applyCommits(address recipient, uint256 amount, bytes32 id, uint256[] r, uint256[] s, uint8[] v)` позволяет любому пользователю блокчейн сети переслать в контракт моста с левой стороны собранные подтверждения о наличии конкретного запроса на отправку нативных токенов через мост из правой стороны. При успешной проверке подверждений контракт пересылает получателю соответствующее количество нативных токенов.

В тестах, перечисленных ниже, за исключением случаев, где это специально оговорено, считается, что 

1. Существуют две блокчейн сети:
    * Сеть `LEFT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`
    * Сеть `RIGHT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`

2. Контракты моста зарегистрированы в блокчейн сетях при следующем содержимом переменных окружения:

    ```
    VALIDATORS=0x17F26d6DEcA57CC5E4cF063a39d3c15AA07845cE 0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc 0x2c89fB4Ff72E7cf512E3BBfb571B8c1FdFaA4b5C
    THRESHOLD=2
    ```

3. Установлена ликвидность моста в 2000 токенов.

### AC-018-01 Пересылка токенов

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов. Через некоторое время в сети `RIGHT` видно, что баланс пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` увеличился на 1000 нативных токенов, а баланс моста уменьшился на эту же сумму.
   
2. Администратор моста отправляет в контаркт моста с правой стороны транзакцию, вызывающую метод `enableRobustMode`. Транзакция исполняется успешно.

3. Администратор моста отправляет в контаркт моста с левой стороны транзакцию, вызывающую метод `enableRobustMode`. Транзакция исполняется успешно.

4. Вызов метода `getRobustModeMessage` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804")` возвращает такой набор данных, который будучи скомпонованный согласно EIP-191 и последующей генерации цифровой подписи с применением приватного ключа соответствющему адресу `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` выдает следующие значени `r,s,v`: `(83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`

5. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` отправляет транзакцию на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающую метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Транзакция исполняется успешно. Выписка транзакции не содержит событие `commitsCollected`.

6. Аккаунт с адресом `0x2c89fB4Ff72E7cf512E3BBfb571B8c1FdFaA4b5C` отправляет транзакцию на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающую метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 48135827190754229963053043410243207876785740969184699695010381114897085221221, 52293708551899676454504291957754549174052542584835142706511678011218859234619, 28)`. Транзакция исполняется успешно. В выписке транзакции есть событие:
    * `commitsCollected("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 2)`

7. Аккаунт с адресом `0x17F26d6DEcA57CC5E4cF063a39d3c15AA07845cE` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 67740533537290287998916608516618072883933156133855606968773029368135942146398, 21337456040719236310399050803970139750915503576430763461362832593000564881009, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

8. Вызов метода `getTransferDetails` с параметром `("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804")` возвращает два значения: `"0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34"` и `10000000000000000000`.

9. Вызов метода `getCommit` с параметрами `("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 0)` возвращает три значения: `83070655859016158973066220145872567032744371849514531218596867127485392225461`, `37652693543851543573717110555775501180194040812995373669946511459990058569296` и `28`.

10. Вызов метода `getCommit` с параметрами `("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 1)` возвращает три значения: `48135827190754229963053043410243207876785740969184699695010381114897085221221`, `52293708551899676454504291957754549174052542584835142706511678011218859234619` и `28`.

11. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` отправляет транзакцию на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающую метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461, 48135827190754229963053043410243207876785740969184699695010381114897085221221], [37652693543851543573717110555775501180194040812995373669946511459990058569296, 52293708551899676454504291957754549174052542584835142706511678011218859234619], [28, 28])`. Транзакция исполняется успешно. После исполнения транзакции баланс пользователя `0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34` увеличился на 10 нативных токенов, а баланс моста уменьшается на эту же сумму.

### AC-018-02 Некорректная посылка подвтерждений в контракт моста на правой стороне

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов. Через некоторое время в сети `RIGHT` видно, что баланс пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` увеличился на 1000 нативных токенов, а баланс моста уменьшился на эту же сумму.
   
2. Администратор моста отправляет в контаркт моста с правой стороны транзакцию, вызывающую метод `enableRobustMode`. Транзакция исполняется успешно.

3. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 67740533537290287998916608516618072883933156133855606968773029368135942146398, 21337456040719236310399050803970139750915503576430763461362832593000564881009, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

4. Аккаунт с адресом `0x17F26d6DEcA57CC5E4cF063a39d3c15AA07845cE` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

5. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 20000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

6. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` отправляет транзакцию на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающую метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Транзакция исполняется успешно. Выписка транзакции не содержит событие `commitsCollected`.

7. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

8. Аккаунт с адресом `0x2c89fB4Ff72E7cf512E3BBfb571B8c1FdFaA4b5C` отправляет транзакцию на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающую метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 48135827190754229963053043410243207876785740969184699695010381114897085221221, 52293708551899676454504291957754549174052542584835142706511678011218859234619, 28)`. Транзакция исполняется успешно. В выписке транзакции есть событие:
    * `commitsCollected("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 2)`

9. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`, вызывающей метод `registerCommit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 83070655859016158973066220145872567032744371849514531218596867127485392225461, 37652693543851543573717110555775501180194040812995373669946511459990058569296, 28)`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

### AC-018-03 Некорректная посылка подвтерждений в контракт моста на левой стороне

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов. Через некоторое время в сети `RIGHT` видно, что баланс пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` увеличился на 1000 нативных токенов, а баланс моста уменьшился на эту же сумму.
   
2. Администратор моста отправляет в контаркт моста с левой стороны транзакцию, вызывающую метод `enableRobustMode`. Транзакция исполняется успешно.

3. Аккаунт с адресом `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `commit` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804")`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

4. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461], [37652693543851543573717110555775501180194040812995373669946511459990058569296], [28])`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

5. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 20000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461, 48135827190754229963053043410243207876785740969184699695010381114897085221221], [37652693543851543573717110555775501180194040812995373669946511459990058569296, 52293708551899676454504291957754549174052542584835142706511678011218859234619], [28, 28])`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

6. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [48135827190754229963053043410243207876785740969184699695010381114897085221221, 48135827190754229963053043410243207876785740969184699695010381114897085221221], [52293708551899676454504291957754549174052542584835142706511678011218859234619, 52293708551899676454504291957754549174052542584835142706511678011218859234619], [28, 28])`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

7. Аккаунт с адресом `0x4910988ab9ece5fe8ffe8260b5557e9572cddab5` отправляет транзакцию на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающую метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461, 48135827190754229963053043410243207876785740969184699695010381114897085221221], [37652693543851543573717110555775501180194040812995373669946511459990058569296, 52293708551899676454504291957754549174052542584835142706511678011218859234619], [28, 28])`. Транзакция исполняется успешно. После исполнения транзакции баланс пользователя `0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34` увеличился на 10 нативных токенов, а баланс моста уменьшается на эту же сумму.

8. Аккаунт с адресом `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461, 48135827190754229963053043410243207876785740969184699695010381114897085221221], [37652693543851543573717110555775501180194040812995373669946511459990058569296, 52293708551899676454504291957754549174052542584835142706511678011218859234619], [28, 28])`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

9. Аккаунт с адресом `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` вызывает JSON RPC метод `eth_estimateGas` для оценки потребления газа перед посылкой транзакции на контракт `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`, вызывающей метод `applyCommits` с параметрами `("0xF91296B9d7699d800c2Ba0a80e755972a9DA7C34", 10000000000000000000, "0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", [83070655859016158973066220145872567032744371849514531218596867127485392225461, 67740533537290287998916608516618072883933156133855606968773029368135942146398], [37652693543851543573717110555775501180194040812995373669946511459990058569296, 21337456040719236310399050803970139750915503576430763461362832593000564881009], [28, 28])`. Вызов `eth_estimateGas` возвращает ошибку, сообщающую о том, что в ходе вызова метода контракта выполнилась команда `revert`.

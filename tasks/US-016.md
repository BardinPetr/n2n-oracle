## US-016 Оракул: Перезапуск оракула

**Описание**: Я, как администратор системы, где запущен оракул, могу быть уверен, что оракул автоматически продолжит работать после перезапуска или переустановки системы, при этом он не будет тратить средства на посылку подвтерждений, которые были уже отправлены до перезапуска/переустановки системы.

В тестах, перечисленных ниже, за исключением случаев, где это специально оговорено, считается, что 

1. Существуют две блокчейн сети:
    * Сеть `LEFT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`
    * Сеть `RIGHT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`

2. Контракты моста зарегистрированы в блокчейн сетях при следующем содержимом переменных окружения:

    ```
    VALIDATORS=0x130930e3E3D30bF8F975a729e948CdCc212ECFBB
    THRESHOLD=1
    ```

3. Установлена ликвидность моста в 2000 токенов.

4. При содежимом файла `.env`:

    ```
    PRIVKEY=<private key corresponding to 0x130930e3E3D30bF8F975a729e948CdCc212ECFBB>
    LEFT_RPCURL=https://sokol.poa.network
    LEFT_ADDRESS=0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441
    LEFT_START_BLOCK=17290597
    LEFT_GASPRICE=5000000000
    RIGHT_RPCURL=https://data-seed-prebsc-1-s1.binance.org:8545/
    RIGHT_ADDRESS=0x159AE4d7012B18A0dE4e390714a6efa036487f0b
    RIGHT_START_BLOCK=5847797
    RIGHT_GASPRICE=10000000000
    ORACLE_DATA=/some/path
    ```
   и пустой директории `/some/path` запускается команда:

    ```
    $ docker-compose up -d
    ```

   При использовании `docker ps -a` видно, что, как минимум, один  контейнеры основывается на образе `n2n-oracle`.

### AC-016-01 Сохранение состояния оракулом

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов.
   
   В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 1000 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение до 1000 нативных токенов.

2. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 10 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B*` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 10 токенов. Баланс моста увеличивается на 10 токенов.
   
   В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B*`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 10 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 10 нативных токенов.

3. Оракул останавливается с помощью команды, запущенной в директории с исходным кодом оракула

    ```
    $ docker-compose down
    ```
   
   Через 10 секунд (максимум) соответствующих docker контейнеров нет в системе.

4. Пользователь, чей приватный ключ соответствует адресу `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` отправляет 27 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B**` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 27 токенов. Баланс моста увеличивается на 27 токенов.

   В сети `LEFT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` и контрактов моста не происходит.

5. Пользователь, чей приватный ключ соответствует адресу `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` отправляет 15 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B***` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 15 токенов. Баланс моста увеличивается на 15 токенов.

   В сети `RIGHT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` и контрактов моста не происходит.

6. Оракул запускается через

    ```
    $ docker-compose up -d
    ```

   При использовании `docker ps -a` видно, что, как минимум, один  контейнеры основывается на образе `n2n-oracle`.

9. В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 30 секунд после запуска оракула, есть только одна транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 27 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 27 нативных токенов.

11. В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 30 секунд послезапуска оракула, есть только одна транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 15 нативных токена стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 15 нативных токена.

### AC-016-02 Восстановления состояния оракулом после очистки системы

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов.
   
   В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 1000 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение до 1000 нативных токенов.

2. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 10 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B*` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 10 токенов. Баланс моста увеличивается на 10 токенов.
   
   В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B*`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 10 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 10 нативных токенов.

3. Оракул останавливается с помощью команды, запущенной в директории с исходным кодом оракула

    ```
    $ docker-compose down
    ```
   
   Через 10 секунд (максимум) соответствующих docker контейнеров нет в системе.

4. Пользователь, чей приватный ключ соответствует адресу `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` отправляет 27 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B**` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 27 токенов. Баланс моста увеличивается на 27 токенов.

   В сети `LEFT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` и контрактов моста не происходит.

5. Пользователь, чей приватный ключ соответствует адресу `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` отправляет 15 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B***` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 15 токенов. Баланс моста увеличивается на 15 токенов.

   В сети `RIGHT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` и контрактов моста не происходит.

6. Удаляется все содержимое директории `/some/path`. После чего запускается оракул через

    ```
    $ docker-compose up -d
    ```

   При использовании `docker ps -a` видно, что, как минимум, один  контейнеры основывается на образе `n2n-oracle`.

9. В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 30 секунд после запуска оракула, есть только одна транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 27 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 27 нативных токенов.

11. В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 30 секунд послезапуска оракула, есть только одна транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 15 нативных токена стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 15 нативных токена.

### AC-016-03 Восстановления состояния оракулом после смены валидатора

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов.
   
   В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 1000 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение до 1000 нативных токенов.

2. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 10 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B*` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 10 токенов. Баланс моста увеличивается на 10 токенов.
   
   В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 15 секунд после появления блока `B*`, есть транзакция от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 10 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 10 нативных токенов.

3. Оракул останавливается с помощью команды, запущенной в директории с исходным кодом оракула

    ```
    $ docker-compose down
    ```
   
   Через 10 секунд (максимум) соответствующих docker контейнеров нет в системе.

4. Пользователь, чей приватный ключ соответствует адресу `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` отправляет 27 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B**` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 27 токенов. Баланс моста увеличивается на 27 токенов.

   В сети `LEFT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` и контрактов моста не происходит.

5. Пользователь, чей приватный ключ соответствует адресу `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` отправляет 15 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B***` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 15 токенов. Баланс моста увеличивается на 15 токенов.

   В сети `RIGHT` в последующих выпущенных блоках нет транзакции от аккаунта `0x130930e3E3D30bF8F975a729e948CdCc212ECFBB`. Изменения балансов пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` и контрактов моста не происходит.

6. Администратор моста отправляет в обе сети по транзакции, вызывающих метод `addValidator` c параметром `("0x61365C58E44A6Fc166897f4A30641dba82E606c0")` в контрактах управления набором валидаторов. Транзакции исполняется успешно.

7. Администратор моста отправляет в обе сети по транзакции, вызывающих метод `removeValidator` c параметром `("0x130930e3E3D30bF8F975a729e948CdCc212ECFBB")` в контрактах управления набором валидаторов. Транзакции исполняется успешно.

8. Удаляется все содержимое директории `/some/path`. Затем, содержимое файла `.env` изменяется следующим образом:

    ```
    PRIVKEY=<private key corresponding to 0x61365C58E44A6Fc166897f4A30641dba82E606c0>
    LEFT_RPCURL=https://sokol.poa.network
    LEFT_ADDRESS=0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441
    LEFT_START_BLOCK=17290597
    LEFT_GASPRICE=5000000000
    RIGHT_RPCURL=https://data-seed-prebsc-1-s1.binance.org:8545/
    RIGHT_ADDRESS=0x159AE4d7012B18A0dE4e390714a6efa036487f0b
    RIGHT_START_BLOCK=5847797
    RIGHT_GASPRICE=10000000000
    ORACLE_DATA=/some/path
    ```
    
    После чего запускается оракул через

    ```
    $ docker-compose up -d
    ```

   При использовании `docker ps -a` видно, что, как минимум, один  контейнеры основывается на образе `n2n-oracle`.

9. В сети `LEFT` в одном из блоков, выпущенном не позднее чем через 30 секунд после запуска оракула, есть только одна транзакция от аккаунта `0x61365C58E44A6Fc166897f4A30641dba82E606c0`. При опросе баланса пользователя `0x666a479f910d0ca5418b00316b93cf5af6b6baa1` в сети `LEFT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 27 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 27 нативных токенов.

10. В сети `RIGHT` в одном из блоков, выпущенном не позднее чем через 30 секунд послезапуска оракула, есть только одна транзакция от аккаунта `0x61365C58E44A6Fc166897f4A30641dba82E606c0`. При опросе баланса пользователя `0xb54edc6dd623e5a50e8aa4e52ff906b63c9bd9cb` в сети `RIGHT` на момент завершения блока, в который включена транзакция от оракула, видно, что на 15 нативных токена стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 15 нативных токена.
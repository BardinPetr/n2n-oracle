## US-024 Контракт моста: ожидание финализации цепочки блоков

**Описание**: Я, как пользователь, хочу быть уверенным, что мостом безопасно пользоваться при кратковременных разветвлениях цепочки блоков, возможных либо во время штатной работы сети (два блока с одним номером выпущены примерно в одинаковое время), либо во время атаки -- транзакции включенных в блоки, которые позднее не войдут в основную цепочку, не будут переданы через мост.

В данной US подразумевается, что оракул начинает полагаться еще на одну переменную окружения `REQUIRED_CONFIRMATIONS`, которая устанавливает количество блоков, которые оракул должен пропустить, прежде чем расценивать цепочку с номерами блоков, меньше текущего на указанное число, как завершенную. Если переменная отсутствует, то подразумевается, что блоки не нужно пропускать (также как и при `REQUIRED_CONFIRMATIONS=0`). Данная настройка применяется к каждой сети, куда направлен оракул.
_Пояснение:_ предположим, что `REQUIRED_CONFIRMATIONS=12` при запуске оракула. Это значит, что если в блоке 54698 появилось событие `bridgeActionInitiated`, то оракул ждет пока над блоком 54698 не появится еще 12 блоков, прежде чем передаст свое подтверждение об инициации передачи токенов через мост.

В тестах, перечисленных ниже, за исключением случаев, где это специально оговорено, считается, что 

1. Существуют две блокчейн сети:
    * Сеть `LEFT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`
    * Сеть `RIGHT`:
      - максимальное количество газа, которое может быть потрачено транзакциями  в блоке `12'500'000`
      - время выпуска блоков в среднем раз в 5 секунд
      - контракт моста находится по адресу `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`

2. Контракты моста зарегистрированы в блокчейн сетях при следующем содержимом переменных окружения:

    ```
    VALIDATORS=0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc
    THRESHOLD=1
    ```

3. Установлена ликвидность моста в 2000 токенов.

4. Оракул запускается при содежимом файла `.env`:

    ```
    PRIVKEY=<private key corresponding to 0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc>
    LEFT_RPCURL=https://sokol.poa.network
    LEFT_ADDRESS=0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441
    LEFT_START_BLOCK=17290597
    LEFT_GASPRICE=5000000000
    RIGHT_RPCURL=https://data-seed-prebsc-1-s1.binance.org:8545/
    RIGHT_ADDRESS=0x159AE4d7012B18A0dE4e390714a6efa036487f0b
    RIGHT_START_BLOCK=5847797
    RIGHT_GASPRICE=10000000000
    ORACLE_DATA=/some/path
    REQUIRED_CONFIRMATIONS=12
    ```

### AC-024-01 отправка подтверждения в обычном режиме

1. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов.
   
   В сети `RIGHT` в одном из блоков, выпущенном чуть позже после того, как в сети `LEFT` выпущен блок `B+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `RIGHT` на момент завершения блока, в который включена успешная транзакция от оракула, видно, что на 1000 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение до 0 нативных токенов.

2. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 50 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B*` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 50 токенов. Баланс моста увеличивается на 50 токенов.
      
   В сети `LEFT` в одном из блоков, выпущенном чуть позже после того, как в сети `RIGHT` выпущен блок `B*+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена успешная транзакция от оракула, видно, что на 50 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 50 нативных токенов.

3. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 30 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция входит в блок `B**` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 30 токенов. Баланс моста увеличивается на 30 токенов.

4. Пока еще в сети `RIGHT` не выпустилось 12 блоков, оракул останавливается, и его `.env` файл меняется так, что в `RIGHT_RPCURL` указан URL узла в сети `RIGHT`, который из-за ошибки синхронизации отстает от основной сети на 24 блока. Оракул запускается снова.

5. В сети `LEFT` в одном из блоков, выпущенном чуть позже после того, как в сети `RIGHT` выпущен блок `B**+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена успешная транзакция от оракула, видно, что на 30 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 30 нативных токенов.

### AC-024-02 отправка подтверждения в режиме экономичной пересылки

1. На каждой стороне моста администратор посылает тарназкции вызывающие `enableRobustMode` в контрактах моста. Транзакции исполняются успешно.

2. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 1000 нативных токенов на адрес `0xfab1ed72a7236a6b34f47ee7Ed103d6CD448c441`. Транзакция входит в блок `B` и исполняется успешно. Баланс пользователя в сети `LEFT` уменьшается на 1000 токенов. Баланс моста увеличивается до 1000 токенов.
   
   В сети `RIGHT` в одном из блоков, выпущенном чуть позже после того, как в сети `LEFT` выпущен блок `B+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `RIGHT` на момент завершения блока, в который включена успешная транзакция от оракула, видно, что на 1000 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение до 0 нативных токенов.

3. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 50 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция `0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804` входит в блок `B*` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 50 токенов. Баланс моста увеличивается на 50 токенов.

   В сети `RIGHT` в одном из блоков `C` c номером выше `B*+12` есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. В выписке транзакции есть событие:
    * `commitsCollected("0xac21bd9c034f02266f79ac064560ea1ed3e8b8ff6491f0f8e433e9122ae4e804", 1)`

   В сети `LEFT` в одном из блоков, выпущенном чуть позже после того, как в сети `RIGHT` выпущен блок `C+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена транзакция оракула, видно, что на 50 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 50 нативных токенов.

4. Пользователь, чей приватный ключ соответствует адресу `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` отправляет 30 нативных токенов на адрес `0x159AE4d7012B18A0dE4e390714a6efa036487f0b`. Транзакция `0xb7a8533489fc70301bee59e5f8760d8db830be076b7a6acf352f8fa6d9d804b5` входит в блок `B**` и исполняется успешно. Баланс пользователя в сети `RIGHT` уменьшается на 30 токенов. Баланс моста увеличивается на 30 токенов.
   
   В сети `RIGHT` в одном из блоков `C*` c номером выше `B**+12` есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. В выписке транзакции есть событие:
    * `commitsCollected("0xb7a8533489fc70301bee59e5f8760d8db830be076b7a6acf352f8fa6d9d804b5", 1)`

5. Пока еще в сети `RIGHT` не выпустилось 12 блоков после блока `C*`, оракул останавливается, и его `.env` файл меняется так, что в `RIGHT_RPCURL` указан URL узла в сети `RIGHT`, который из-за ошибки синхронизации отстает от основной сети на 24 блока. Оракул запускается снова.

6. В сети `LEFT` в одном из блоков, выпущенном чуть позже после того, как в сети `RIGHT` выпущен блок `C*+12`, есть транзакция от `0xaF1E1D6C3cedD99DA7df3a91F5B956AB6d2eC3Fc`. При опросе баланса пользователя `0x5580ba66f8d6dc71adb0ca1d1c6b3d142ff7aaca` в сети `LEFT` на момент завершения блока, в который включена успешная транзакция от оракула, видно, что на 30 нативных токенов стало больше. При аналогичном запросе для баланса моста видно его уменьшение на 30 нативных токенов.